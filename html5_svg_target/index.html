<!DOCTYPE HTML>
<html>
    <head>
        <style>
            body {
                background-color: lightgray;
            }

            .display {
                width: 800px;
                height: 600px;
                background-color: white;
                border: 2px black;
                
                position:absolute;
                left:0; right:0;
                top:0; bottom:0;
                margin:auto;
                
                max-width:100%;
                max-height:100%;
                overflow:auto;
            }
        </style>
    </head>
    <body>
        <script src="display_driver.js"></script>
        <script>
            function instantiate(bytes, imports) {
                return WebAssembly.compile(bytes).then(m => new WebAssembly.Instance(m, imports));
            }

            var display_obj_map = [];
            var display_obj_map_free_ids = [];
            var svgns = "http://www.w3.org/2000/svg";

            var display_obj_map_new_id = function() {
                if (display_obj_map_free_ids.length > 0) {
                    return display_obj_map_free_ids.pop();
                } else {
                    return display_obj_map.length;
                }
            };

            var display_obj_map_free_id = function(id) {
                display_obj_map_free_ids.push(id);
            };

            var importObject = {
                env: {
                    log: function(arg) {
                      console.log(arg);
                    },
                    display_add_circle: function(x, y, r) {
                        var display = document.getElementById("display");
                        var circle = document.createElementNS(svgns, "circle");
                        circle.setAttributeNS(null, "cx", x);
                        circle.setAttributeNS(null, "cy", y);
                        circle.setAttributeNS(null, "r", r);
                        display.appendChild(circle);
                        var id = display_obj_map_new_id();
                        display_obj_map[id] = circle;
                        return id;
                    },
                    display_move_circle: function(id, x, y) {
                        var circle = display_obj_map[id];
                        circle.setAttributeNS(null, "cx", x);
                        circle.setAttributeNS(null, "cy", y);
                    },
                    display_remove: function(id) {
                        var display = document.getElementById("display");
                        display.removeChild(display_obj_map[id]);
                        display_obj_map[id] = null;
                        display_obj_map_free_id(id);
                    }
                  }
                };
            
            fetch('sodium_rust_demo.wasm')
                .then(response => response.arrayBuffer())
                .then(bytes => WebAssembly.instantiate(bytes, importObject))
                .then(results => {
                    var create_app_ctx = results.instance.exports.create_app_ctx;
                    var test = results.instance.exports.test;
                    var app_ctx = create_app_ctx();
                    test(app_ctx);
                });
        </script>
        <svg id="display" class="display">
        </svg>
    </body>
</html>
